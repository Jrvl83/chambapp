rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Usuarios - lectura publica, escritura solo el propio usuario
    match /usuarios/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Subcoleccion de notificaciones - solo el propio usuario
      match /notificaciones/{notifId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Ofertas - lectura publica, escritura usuarios autenticados
    match /ofertas/{ofertaId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        (resource.data.usuarioId == request.auth.uid ||
         resource.data.empleadorId == request.auth.uid ||
         resource.data.empleadorEmail == request.auth.token.email);
    }

    // Aplicaciones - lectura y escritura usuarios autenticados
    // Nota: La seguridad se maneja en las queries (filtran por email/id del usuario)
    match /aplicaciones/{aplicacionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
    }

    // Calificaciones - lectura publica, escritura usuarios autenticados
    match /calificaciones/{calificacionId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null &&
        (resource.data.trabajadorId == request.auth.uid ||
         resource.data.empleadorId == request.auth.uid);
    }
  }
}
